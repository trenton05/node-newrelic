<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Tutorial: Transaction State Preservation</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme-without-scrollbar.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="API.html">API</a></div><div class="sidebar-section-children"><a href="ClassWrapSpec.html">ClassWrapSpec</a></div><div class="sidebar-section-children"><a href="DatastoreParameters.html">DatastoreParameters</a></div><div class="sidebar-section-children"><a href="DatastoreShim.html">DatastoreShim</a></div><div class="sidebar-section-children"><a href="InstrumentationDescriptor.html">InstrumentationDescriptor</a></div><div class="sidebar-section-children"><a href="MessageShim.html">MessageShim</a></div><div class="sidebar-section-children"><a href="MessageSpec.html">MessageSpec</a></div><div class="sidebar-section-children"><a href="MessageSubscribeSpec.html">MessageSubscribeSpec</a></div><div class="sidebar-section-children"><a href="MiddlewareMounterSpec.html">MiddlewareMounterSpec</a></div><div class="sidebar-section-children"><a href="MiddlewareSpec.html">MiddlewareSpec</a></div><div class="sidebar-section-children"><a href="OperationSpec.html">OperationSpec</a></div><div class="sidebar-section-children"><a href="PromiseShim.html">PromiseShim</a></div><div class="sidebar-section-children"><a href="QuerySpec.html">QuerySpec</a></div><div class="sidebar-section-children"><a href="QueueMessageParameters.html">QueueMessageParameters</a></div><div class="sidebar-section-children"><a href="RecorderSpec.html">RecorderSpec</a></div><div class="sidebar-section-children"><a href="RenderSpec.html">RenderSpec</a></div><div class="sidebar-section-children"><a href="SegmentSpec.html">SegmentSpec</a></div><div class="sidebar-section-children"><a href="Shim.html">Shim</a></div><div class="sidebar-section-children"><a href="TransactionHandle.html">TransactionHandle</a></div><div class="sidebar-section-children"><a href="TransactionShim.html">TransactionShim</a></div><div class="sidebar-section-children"><a href="TransactionSpec.html">TransactionSpec</a></div><div class="sidebar-section-children"><a href="WebFrameworkShim.html">WebFrameworkShim</a></div><div class="sidebar-section-children"><a href="WrapSpec.html">WrapSpec</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Context-Preservation.html">Transaction State Preservation</a></div><div class="sidebar-section-children"><a href="tutorial-Datastore-Simple.html">Intro to Datastore Instrumentation</a></div><div class="sidebar-section-children"><a href="tutorial-Instrumentation-Basics.html">Instrumentation Basics</a></div><div class="sidebar-section-children"><a href="tutorial-Messaging-Simple.html">Intro to Message Broker Instrumentation</a></div><div class="sidebar-section-children"><a href="tutorial-Webframework-Simple.html">Intro to Web Framework Instrumentation</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-interfaces"><div>Interfaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="ParsedQueryData.html">ParsedQueryData</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#CallbackBindFunction">CallbackBindFunction</a></div><div class="sidebar-section-children"><a href="global.html#ClassWrapSpecParams">ClassWrapSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#ConstructorHookFunction">ConstructorHookFunction</a></div><div class="sidebar-section-children"><a href="global.html#DatastoreParametersParams">DatastoreParametersParams</a></div><div class="sidebar-section-children"><a href="global.html#InContextCallback">InContextCallback</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationDescriptorParams">InstrumentationDescriptorParams</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationOnError">InstrumentationOnError</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationOnRequire">InstrumentationOnRequire</a></div><div class="sidebar-section-children"><a href="global.html#MessageBrokerHeadersFn">MessageBrokerHeadersFn</a></div><div class="sidebar-section-children"><a href="global.html#MessageConsumerWrapperFunction">MessageConsumerWrapperFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageFunction">MessageFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageHandlerFunction">MessageHandlerFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageSpecParams">MessageSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MessageSubscribeSpecParams">MessageSubscribeSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareMounterSpecParams">MiddlewareMounterSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareSpecParams">MiddlewareSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareTypeNames">MiddlewareTypeNames</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareWrapperFunction">MiddlewareWrapperFunction</a></div><div class="sidebar-section-children"><a href="global.html#OperationSpecParams">OperationSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#QueryFunction">QueryFunction</a></div><div class="sidebar-section-children"><a href="global.html#QueryParserFunction">QueryParserFunction</a></div><div class="sidebar-section-children"><a href="global.html#QuerySpecFunction">QuerySpecFunction</a></div><div class="sidebar-section-children"><a href="global.html#QuerySpecParams">QuerySpecParams</a></div><div class="sidebar-section-children"><a href="global.html#QueueMessageParametersParams">QueueMessageParametersParams</a></div><div class="sidebar-section-children"><a href="global.html#RecorderFunction">RecorderFunction</a></div><div class="sidebar-section-children"><a href="global.html#RecorderSpecParams">RecorderSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#RenderSpecParams">RenderSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#RouteNextFunction">RouteNextFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteParameterFunction">RouteParameterFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteParserFunction">RouteParserFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteRequestFunction">RouteRequestFunction</a></div><div class="sidebar-section-children"><a href="global.html#SegmentFunction">SegmentFunction</a></div><div class="sidebar-section-children"><a href="global.html#SegmentSpecParams">SegmentSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#SpecAfterFunction">SpecAfterFunction</a></div><div class="sidebar-section-children"><a href="global.html#TransactionSpecParams">TransactionSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#WrapFunction">WrapFunction</a></div><div class="sidebar-section-children"><a href="global.html#WrapSpecParams">WrapSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#createShimFromType">createShimFromType</a></div><div class="sidebar-section-children"><a href="global.html#startSegmentCallback">startSegmentCallback</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section><header><h2>Transaction State Preservation</h2></header><article><h3 id="introduction">Introduction</h3><p>This tutorial goes over an example instrumentation of a library that loses transaction state, and some of the difficulties associated with doing so. The sample instrumentation will be <a href="https://www.npmjs.com/package/generic-pool"><code>generic-pool</code></a>.</p><p>Here is the full code for this instrumentation, which will be broken down in more detail below:</p><pre class="prettyprint source lang-js"><code>module.exports = function initialize(agent, generic, moduleName, shim) {
  var proto = generic && generic.Pool && generic.Pool.prototype

  function wrapPool(pool)
    shim.wrap(pool, 'acquire', function wrapAcquire(shim, original, name, callback) {
      return function wrappedAcquire(callback, priority) {
        return original.call(this, shim.bindSegment(callback), priority)
      }
    })
  }

  if (proto && proto.acquire) {
    wrapPool(proto)
  } else {
    shim.wrapReturn(generic, 'Pool', function wrapPooler(shim, original, name, pooler) {
      wrapPool(pooler)
    })
  }
}
</code></pre><h3 id="motivation">Motivation</h3><p>We would like to time the execution of all code that was caused by a certain event. This package of associated timings is called a transaction, and an http request is the typical event that caused it. This can be difficult since Node executes javascript in an asynchronous fashion, leading to potentially disparate call stacks.</p><p>When javascript is executed by Node, more code can be queued in libuv or v8 to execute asynchronously through functions like <code>setTimeout</code>. These asynchronous functions will delay execution of their callbacks until some point in the future, and upon execution there will be no context data stored about the origin of the callback. These asynchronous boundaries pose an issue when trying to associate where a particular piece of code was queued.</p><p>As of writing this, there are no general solutions to carrying state over these asynchronous boundaries. Domains were an attempt at this, but have since been deprecated. This is one of the important roles of instrumentation. Even if generating timing information for a certain module isn't desired, it may be necessary to create instrumentation for it to maintain transaction state over an asynchronous boundary introduced in the module.</p><p>There are two major symptoms of uninstrumented asynchronous methods: complete transaction state loss and confounded transactions. Completely losing transaction state typically manifests in lost data and is most commonly caused by calls into asynchronous native code that the agent is unaware of. Conflated transactions can lead to one transaction's data ending up on another, effectively making the data untrustworthy and useless.</p><p>The way we treat both situations is the same: when the asynchronous function is invoked, wrap the callback in a closure that will restore context before executing the original reentry code.</p><h3 id="generic-pool-breakdown">Generic Pool Breakdown</h3><p>The <code>generic-pool</code> module exports a <a href="https://github.com/coopernurse/node-pool/blob/v2.5.4/lib/generic-pool.js#L630">constructor</a> it uses for its job pooling. In order to follow execution in the pool, we need to use <a href="Shim.html#bindSegment"><code>Shim#bindSegment</code></a> on the <a href="https://github.com/coopernurse/node-pool/blob/v2.5.4/lib/generic-pool.js#L428"><code>acquire</code></a> method. As of v2 of the library this method is placed on the prototype of the constructor, wrapping this as so will suffice:</p><pre class="prettyprint source lang-js"><code>module.exports = function initialize(agent, generic, moduleName, shim) {
  var proto = generic && generic.Pool && generic.Pool.prototype

  function wrapPool(pool)
    shim.wrap(pool, 'acquire', function wrapAcquire(shim, original, name, callback) {
      return function wrappedAcquire(callback, priority) {
        return original.call(this, shim.bindSegment(callback), priority)
      }
    })
  }


  wrapPool(proto)
}
</code></pre><p>However, in v1 of the module, there is no prototype on this constructor, and we must wrap <a href="https://github.com/coopernurse/node-pool/blob/v1.0.12/lib/generic-pool.js#L262"><code>acquire</code></a> on the constructed object using <a href="Shim.html#wrapReturn"><code>Shim#wrapReturn</code></a> as so:</p><pre class="prettyprint source lang-js"><code>module.exports = function initialize(agent, generic, moduleName, shim) {
  function wrapPool(pool)
    shim.wrap(pool, 'acquire', function wrapAcquire(shim, original, name, callback) {
      return function wrappedAcquire(callback, priority) {
        return original.call(this, shim.bindSegment(callback), priority)
      }
    })
  }

  shim.wrapReturn(generic, 'Pool', function wrapPooler(shim, original, name, pooler) {
    wrapPool(pooler)
  })
}
</code></pre><p>In order to handle both cases, we will check for <code>acquire</code> on the prototype and wrap on that before defaulting to wrapping the return value of the constructor:</p><pre class="prettyprint source lang-js"><code>module.exports = function initialize(agent, generic, moduleName, shim) {
  var proto = generic && generic.Pool && generic.Pool.prototype

  function wrapPool(pool)
    shim.wrap(pool, 'acquire', function wrapAcquire(shim, original, name, callback) {
      return function wrappedAcquire(callback, priority) {
        return original.call(this, shim.bindSegment(callback), priority)
      }
    })
  }

  if (proto && proto.acquire) {
    wrapPool(proto)
  } else {
    shim.wrapReturn(generic, 'Pool', function wrapPooler(shim, original, name, pooler) {
      wrapPool(pooler)
    })
  }
}
</code></pre><p>Note we don't write instrumentation for v3 of the library, since it is promise based and state should be preserved by our promise instrumentation.</p><h3 id="toy-example">Toy example</h3><p>In order to fully illustrate the process let's instrument a homemade work queuing system. Consider the following code which queues functions and executes them in batches every second:</p><pre class="prettyprint source lang-js"><code>'use strict'

function Queue() {
  this.jobs = []
}

function run(jobs) {
  while (jobs.length) {
    jobs.pop()()
  }
}

Queue.prototype.scheduleJob = function scheduleJob(job) {
  var queue = this
  process.nextTick(function() {
    if (queue.jobs.length === 0) {
      setTimeout(run, 1000, queue.jobs)
    }
    queue.jobs.push(job)
  })
}

module.exports = Queue
</code></pre><p>With example code that uses it:</p><pre class="prettyprint source lang-js"><code>var Queue = require('jobQueue')
var queue = new Queue()

queue.scheduleJob(function() {
  console.log('this prints first')
})

var i = 0
queue.scheduleJob(function counter() {
  console.log(i++)
  queue.scheduleJob(counter)
})
</code></pre><p>In order to properly instrument this system, we'd like to call <a href="Shim.html#bindSegment"><code>Shim#bindSegment</code></a> on the job functions on their way into the system. To prove that the instrumentation is broken, let's modify the example to illustrate the undesired behavior.</p><pre class="prettyprint source lang-js"><code>var nr = require('newrelic')

var Queue = require('jobQueue')
var queue = new Queue()

nr.startBackgroundTransaction('firstTransaction', function first() {
  var transaction = nr.getTransaction()
  queue.scheduleJob(function firstJob() {
    // Do some work
    transaction.end()
  })
})

nr.startBackgroundTransaction('secondTransaction', function second() {
  var transaction = nr.getTransaction()
  queue.scheduleJob(function secondJob() {
    // Do some work

    // Transaction state will be lost here because 'firstTransaction' will have
    // already ended the transaction
    transaction.end()
  })
})
</code></pre><p>Without instrumentation executing this code will cause <code>'firstTransaction'</code> to be the active transaction in both <code>firstJob</code> and <code>secondJob</code>. This confounding of transactions is due to the <code>scheduleJob</code> method using <code>setTimeout</code> to queue the running of jobs. When the callback to <code>setTimeout</code> is called the transaction that was active when <code>setTimeout</code> was invoked will be restored. Since <code>'firstTransaction'</code> is active when <code>setTimeout</code> is called, this is restored and <code>firstJob</code> is invoked, ending the transaction. When the queue gets around to executing <code>secondJob</code> the <code>'firstTransaction'</code> has already been ended, and the current executing transaction will be <code>null</code>. If <code>firstJob</code> didn't end the transaction, the work done in <code>secondJob</code> would be incorrectly associated with <code>'firstTransaction'</code>. Now that we have a test case we can start writing our instrumentation for the work queue. This behavior can be seen in the UI:</p><p><a href="https://docs.newrelic.com/docs/apm/applications-menu/monitoring/transactions-page"><img src="./confounded-txns.png" alt="confounded transactions" style="text-align:center;width:100%"></a></p><p>The instrumentation will be relatively simple, we just need to call <a href="Shim.html#bindSegment"><code>Shim#bindSegment</code></a> on the jobs as they are passed in. The purpose of this instrumentation is to wrap the job in a function that will restore transaction context for the duration of the job's execution. Note this instrumentation will not handle timing the queue or the work executed by it, in order to do that we would use <a href="Shim.html#record"><code>Shim#record</code></a>. Enough with the prose, here is the instrumentation in its entirety:</p><pre class="prettyprint source lang-js"><code>var nr = require('newrelic')
nr.instrument(
  'jobQueue',
  function onRequire(shim, jobQueue) {
    shim.wrap(
      jobQueue.prototype,
      'scheduleJob',
      function wrapJob(shim, original){
        return function wrappedScheduleJob(job) {
          return original.call(this, shim.bindSegment(job))
        }
      }
    )
  }
)
</code></pre><p>After executing the above code before calling <code>require('jobQueue')</code> we can tell the agent to instrument the module on require as so:</p><pre class="prettyprint source lang-js"><code>var nr = require('newrelic')

nr.instrument(
  'jobQueue',
  function onRequire(shim, jobQueue) {
    shim.wrap(
      jobQueue.prototype,
      'scheduleJob',
      function wrapJob(shim, original){
        return function wrappedScheduleJob(job) {
          return original.call(this, shim.bindSegment(job))
        }
      }
    )
  }
)

var Queue = require('jobQueue')
var queue = new Queue()

nr.startBackgroundTransaction('firstTransaction', function first() {
  var transaction = nr.getTransaction()
  queue.scheduleJob(function firstJob() {
    // Do some work
    transaction.end()
  })
})

nr.startBackgroundTransaction('secondTransaction', function second() {
  var transaction = nr.getTransaction()
  queue.scheduleJob(function secondJob() {
    // Do some work

    // Transaction state will be lost here because 'firstTransaction' will have
    // already ended the transaction
    transaction.end()
  })
})
</code></pre><p>The correct instrumentation should be noticeable in the UI as now both transactions appear, and the timer used by the work queue appears as a segment in <code>'firstTransaction'</code></p><p><a href="https://docs.newrelic.com/docs/apm/applications-menu/monitoring/transactions-page"><img src="./proper-txns.png" alt="transaction breakdown" style="text-align:center;width:100%"></a></p><h3 id="questions%3F">Questions?</h3><p>We have an extensive <a href="https://support.newrelic.com/">help site</a> as well as <a href="https://docs.newrelic.com/">documentation</a>. If you can't find your answers there, please drop us a line on the <a href="https://discuss.newrelic.com/">community forum</a>.</p></article></section></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="API.html">API</a></div><div class="sidebar-section-children"><a href="ClassWrapSpec.html">ClassWrapSpec</a></div><div class="sidebar-section-children"><a href="DatastoreParameters.html">DatastoreParameters</a></div><div class="sidebar-section-children"><a href="DatastoreShim.html">DatastoreShim</a></div><div class="sidebar-section-children"><a href="InstrumentationDescriptor.html">InstrumentationDescriptor</a></div><div class="sidebar-section-children"><a href="MessageShim.html">MessageShim</a></div><div class="sidebar-section-children"><a href="MessageSpec.html">MessageSpec</a></div><div class="sidebar-section-children"><a href="MessageSubscribeSpec.html">MessageSubscribeSpec</a></div><div class="sidebar-section-children"><a href="MiddlewareMounterSpec.html">MiddlewareMounterSpec</a></div><div class="sidebar-section-children"><a href="MiddlewareSpec.html">MiddlewareSpec</a></div><div class="sidebar-section-children"><a href="OperationSpec.html">OperationSpec</a></div><div class="sidebar-section-children"><a href="PromiseShim.html">PromiseShim</a></div><div class="sidebar-section-children"><a href="QuerySpec.html">QuerySpec</a></div><div class="sidebar-section-children"><a href="QueueMessageParameters.html">QueueMessageParameters</a></div><div class="sidebar-section-children"><a href="RecorderSpec.html">RecorderSpec</a></div><div class="sidebar-section-children"><a href="RenderSpec.html">RenderSpec</a></div><div class="sidebar-section-children"><a href="SegmentSpec.html">SegmentSpec</a></div><div class="sidebar-section-children"><a href="Shim.html">Shim</a></div><div class="sidebar-section-children"><a href="TransactionHandle.html">TransactionHandle</a></div><div class="sidebar-section-children"><a href="TransactionShim.html">TransactionShim</a></div><div class="sidebar-section-children"><a href="TransactionSpec.html">TransactionSpec</a></div><div class="sidebar-section-children"><a href="WebFrameworkShim.html">WebFrameworkShim</a></div><div class="sidebar-section-children"><a href="WrapSpec.html">WrapSpec</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Context-Preservation.html">Transaction State Preservation</a></div><div class="sidebar-section-children"><a href="tutorial-Datastore-Simple.html">Intro to Datastore Instrumentation</a></div><div class="sidebar-section-children"><a href="tutorial-Instrumentation-Basics.html">Instrumentation Basics</a></div><div class="sidebar-section-children"><a href="tutorial-Messaging-Simple.html">Intro to Message Broker Instrumentation</a></div><div class="sidebar-section-children"><a href="tutorial-Webframework-Simple.html">Intro to Web Framework Instrumentation</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-interfaces"><div>Interfaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="ParsedQueryData.html">ParsedQueryData</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#CallbackBindFunction">CallbackBindFunction</a></div><div class="sidebar-section-children"><a href="global.html#ClassWrapSpecParams">ClassWrapSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#ConstructorHookFunction">ConstructorHookFunction</a></div><div class="sidebar-section-children"><a href="global.html#DatastoreParametersParams">DatastoreParametersParams</a></div><div class="sidebar-section-children"><a href="global.html#InContextCallback">InContextCallback</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationDescriptorParams">InstrumentationDescriptorParams</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationOnError">InstrumentationOnError</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationOnRequire">InstrumentationOnRequire</a></div><div class="sidebar-section-children"><a href="global.html#MessageBrokerHeadersFn">MessageBrokerHeadersFn</a></div><div class="sidebar-section-children"><a href="global.html#MessageConsumerWrapperFunction">MessageConsumerWrapperFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageFunction">MessageFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageHandlerFunction">MessageHandlerFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageSpecParams">MessageSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MessageSubscribeSpecParams">MessageSubscribeSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareMounterSpecParams">MiddlewareMounterSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareSpecParams">MiddlewareSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareTypeNames">MiddlewareTypeNames</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareWrapperFunction">MiddlewareWrapperFunction</a></div><div class="sidebar-section-children"><a href="global.html#OperationSpecParams">OperationSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#QueryFunction">QueryFunction</a></div><div class="sidebar-section-children"><a href="global.html#QueryParserFunction">QueryParserFunction</a></div><div class="sidebar-section-children"><a href="global.html#QuerySpecFunction">QuerySpecFunction</a></div><div class="sidebar-section-children"><a href="global.html#QuerySpecParams">QuerySpecParams</a></div><div class="sidebar-section-children"><a href="global.html#QueueMessageParametersParams">QueueMessageParametersParams</a></div><div class="sidebar-section-children"><a href="global.html#RecorderFunction">RecorderFunction</a></div><div class="sidebar-section-children"><a href="global.html#RecorderSpecParams">RecorderSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#RenderSpecParams">RenderSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#RouteNextFunction">RouteNextFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteParameterFunction">RouteParameterFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteParserFunction">RouteParserFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteRequestFunction">RouteRequestFunction</a></div><div class="sidebar-section-children"><a href="global.html#SegmentFunction">SegmentFunction</a></div><div class="sidebar-section-children"><a href="global.html#SegmentSpecParams">SegmentSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#SpecAfterFunction">SpecAfterFunction</a></div><div class="sidebar-section-children"><a href="global.html#TransactionSpecParams">TransactionSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#WrapFunction">WrapFunction</a></div><div class="sidebar-section-children"><a href="global.html#WrapSpecParams">WrapSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#createShimFromType">createShimFromType</a></div><div class="sidebar-section-children"><a href="global.html#startSegmentCallback">startSegmentCallback</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>