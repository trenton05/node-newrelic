<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Tutorial: Intro to Web Framework Instrumentation</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme-without-scrollbar.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="API.html">API</a></div><div class="sidebar-section-children"><a href="ClassWrapSpec.html">ClassWrapSpec</a></div><div class="sidebar-section-children"><a href="DatastoreParameters.html">DatastoreParameters</a></div><div class="sidebar-section-children"><a href="DatastoreShim.html">DatastoreShim</a></div><div class="sidebar-section-children"><a href="InstrumentationDescriptor.html">InstrumentationDescriptor</a></div><div class="sidebar-section-children"><a href="MessageShim.html">MessageShim</a></div><div class="sidebar-section-children"><a href="MessageSpec.html">MessageSpec</a></div><div class="sidebar-section-children"><a href="MessageSubscribeSpec.html">MessageSubscribeSpec</a></div><div class="sidebar-section-children"><a href="MiddlewareMounterSpec.html">MiddlewareMounterSpec</a></div><div class="sidebar-section-children"><a href="MiddlewareSpec.html">MiddlewareSpec</a></div><div class="sidebar-section-children"><a href="OperationSpec.html">OperationSpec</a></div><div class="sidebar-section-children"><a href="PromiseShim.html">PromiseShim</a></div><div class="sidebar-section-children"><a href="QuerySpec.html">QuerySpec</a></div><div class="sidebar-section-children"><a href="QueueMessageParameters.html">QueueMessageParameters</a></div><div class="sidebar-section-children"><a href="RecorderSpec.html">RecorderSpec</a></div><div class="sidebar-section-children"><a href="RenderSpec.html">RenderSpec</a></div><div class="sidebar-section-children"><a href="SegmentSpec.html">SegmentSpec</a></div><div class="sidebar-section-children"><a href="Shim.html">Shim</a></div><div class="sidebar-section-children"><a href="TransactionHandle.html">TransactionHandle</a></div><div class="sidebar-section-children"><a href="TransactionShim.html">TransactionShim</a></div><div class="sidebar-section-children"><a href="TransactionSpec.html">TransactionSpec</a></div><div class="sidebar-section-children"><a href="WebFrameworkShim.html">WebFrameworkShim</a></div><div class="sidebar-section-children"><a href="WrapSpec.html">WrapSpec</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Context-Preservation.html">Transaction State Preservation</a></div><div class="sidebar-section-children"><a href="tutorial-Datastore-Simple.html">Intro to Datastore Instrumentation</a></div><div class="sidebar-section-children"><a href="tutorial-Instrumentation-Basics.html">Instrumentation Basics</a></div><div class="sidebar-section-children"><a href="tutorial-Messaging-Simple.html">Intro to Message Broker Instrumentation</a></div><div class="sidebar-section-children"><a href="tutorial-Webframework-Simple.html">Intro to Web Framework Instrumentation</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-interfaces"><div>Interfaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="ParsedQueryData.html">ParsedQueryData</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#CallbackBindFunction">CallbackBindFunction</a></div><div class="sidebar-section-children"><a href="global.html#ClassWrapSpecParams">ClassWrapSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#ConstructorHookFunction">ConstructorHookFunction</a></div><div class="sidebar-section-children"><a href="global.html#DatastoreParametersParams">DatastoreParametersParams</a></div><div class="sidebar-section-children"><a href="global.html#InContextCallback">InContextCallback</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationDescriptorParams">InstrumentationDescriptorParams</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationOnError">InstrumentationOnError</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationOnRequire">InstrumentationOnRequire</a></div><div class="sidebar-section-children"><a href="global.html#MessageBrokerHeadersFn">MessageBrokerHeadersFn</a></div><div class="sidebar-section-children"><a href="global.html#MessageConsumerWrapperFunction">MessageConsumerWrapperFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageFunction">MessageFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageHandlerFunction">MessageHandlerFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageSpecParams">MessageSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MessageSubscribeSpecParams">MessageSubscribeSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareMounterSpecParams">MiddlewareMounterSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareSpecParams">MiddlewareSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareTypeNames">MiddlewareTypeNames</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareWrapperFunction">MiddlewareWrapperFunction</a></div><div class="sidebar-section-children"><a href="global.html#OperationSpecParams">OperationSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#QueryFunction">QueryFunction</a></div><div class="sidebar-section-children"><a href="global.html#QueryParserFunction">QueryParserFunction</a></div><div class="sidebar-section-children"><a href="global.html#QuerySpecFunction">QuerySpecFunction</a></div><div class="sidebar-section-children"><a href="global.html#QuerySpecParams">QuerySpecParams</a></div><div class="sidebar-section-children"><a href="global.html#QueueMessageParametersParams">QueueMessageParametersParams</a></div><div class="sidebar-section-children"><a href="global.html#RecorderFunction">RecorderFunction</a></div><div class="sidebar-section-children"><a href="global.html#RecorderSpecParams">RecorderSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#RenderSpecParams">RenderSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#RouteNextFunction">RouteNextFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteParameterFunction">RouteParameterFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteParserFunction">RouteParserFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteRequestFunction">RouteRequestFunction</a></div><div class="sidebar-section-children"><a href="global.html#SegmentFunction">SegmentFunction</a></div><div class="sidebar-section-children"><a href="global.html#SegmentSpecParams">SegmentSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#SpecAfterFunction">SpecAfterFunction</a></div><div class="sidebar-section-children"><a href="global.html#TransactionSpecParams">TransactionSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#WrapFunction">WrapFunction</a></div><div class="sidebar-section-children"><a href="global.html#WrapSpecParams">WrapSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#createShimFromType">createShimFromType</a></div><div class="sidebar-section-children"><a href="global.html#startSegmentCallback">startSegmentCallback</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section><header><h2>Intro to Web Framework Instrumentation</h2></header><article><h3 id="pre-requisite">Pre-requisite</h3><p><a href="tutorial-Instrumentation-Basics.html">Instrumentation Basics</a></p><h3 id="introduction">Introduction</h3><p>This tutorial goes over basic concepts of using the WebFramework instrumentation API. In order to demonstrate the topics, we will use a hypothetical web framework that has similar concepts to popular web frameworks such as Express or Restify.</p><p>Here is an example of how the web framework would be used in a user's code:</p><pre class="prettyprint source lang-js"><code>const myWebFramework = require('my-web-framework')
const authenticate = require('./lib/authenticate')

// create server
let server = new myWebFramework.Server()

server.all(function authenticateMiddleware(req, res, next) {
  if (authenticate()) {
    next()
  } else {
    res.statusCode = 403
    res.end()
  }
})

server.get('/api/users', function(req, res) {
  res.write(getUsers())
  res.end()
})

server.get('/home', function(req, res) {
  this.render('home', function(err, renderedView) {
    res.write(renderedView)
    res.end()
  })
})

server.start(8080)
</code></pre><p>In this example, the web application server is serving two endpoints. Endpoint <code>/api/users</code> returns a list of users as JSON data. The second endpoint <code>/home</code> renders and returns an HTML view. It also has an authentication middleware that is executed for any type of request.</p><h3 id="the-instrumentation-function">The Instrumentation Function</h3><p>To add instrumentation to a web framework, you supply a single function which is responsible for telling New Relic which framework methods should be instrumented and what metrics and data to collect. The agent calls this instrumentation function automatically when the web framework module is required in the user's code. The function must be registered with the agent by calling <a href="API.html#instrumentWebframework"><code>API#instrumentWebframework</code></a>.</p><pre class="prettyprint source lang-js"><code>const newrelic = require('newrelic')
newrelic.instrumentWebframework('my-web-framework', instrumentMyWebFramework)
</code></pre><p>The instrumentation function can be included in the application code itself or it can live in a separate instrumentation module. In either case, we need to register it in our application code in order for the agent to use it.</p><p>The instrumentation function has the following signature:</p><pre class="prettyprint source lang-js"><code>function instrumentMyWebFramework(shim, myModule, moduleName) {
</code></pre><p>It receives a <a href="WebFrameworkShim.html"><code>WebFrameworkShim</code></a>, the module to instrument and the name of the package.</p><p>For more details, see <a href="tutorial-Instrumentation-Basics.html">Instrumentation Basics</a>.</p><h3 id="specifying-the-framework">Specifying the Framework</h3><p>The first thing the instrumentation should do is specify the name of the framework it is instrumenting. The value is used as a part of metric names and transaction event attributes. It is also displayed in the Environment view.</p><pre class="prettyprint source lang-js"><code>  shim.setFramework('MyCustom')
</code></pre><p>[<img src="./breakdown-table-web-framework.png" alt="transaction breakdown" style="text-align:center;width:100%">]</p><h3 id="what-to-record">What to Record</h3><p>Web framework instrumentation will generally be responsible for the following:</p><ul><li>naming the transaction</li><li>recording metrics for middleware functions</li><li>recording metrics for rendering views</li><li>reporting errors that are handled by the web framework</li></ul><h3 id="transaction-naming">Transaction Naming</h3><p>A single transaction represents all activity that is tied to a single HTTP request from the time it is received until the app server sends a response back. In order to see meaningful metrics for similar transactions (e.g. ones that hit the same URL endpoint), the instrumentation needs to determine and assign a name for each transaction.</p><p>The Node agent names transactions using the HTTP verb and the request URI. The verb is automatically determined from the HTTP request. However, the URI must typically be normalized in order to group related transactions in a meaningful way. For more details, see <a href="https://docs.newrelic.com/docs/agents/manage-apm-agents/troubleshooting/metric-grouping-issues">Metric grouping issues</a>.</p><p>The API provides a basic function for setting the URI to use for naming - <a href="WebFrameworkShim.html#setTransactionUri"><code>WebFrameworkShim#setTransactionUri</code></a>. This would be sufficient for a very basic use case when the URI can be determined in a single point in the instrumentation code.</p><p>However, many common web frameworks route each request through many functions, which may contribute to the final name. In order to help with the common use case of nested middlewares, the API provides a mechanism for naming transactions based on paths that middleware functions are mounted on.</p><h3 id="middlewares">Middlewares</h3><p>Many frameworks have a concept of middlewares. Middleware is a function that is executed in response to a request for a specific URL endpoint. Middleware can either respond to the HTTP request or pass control to another middleware.</p><p>Since there can be many middlewares executed for a single request, it is useful to know how much time is spent in each middleware when troubleshooting performance.</p><p>[<img src="./tx-breakdown-web-api.png" alt="transaction breakdown" style="text-align:center;width:100%">]</p><p>There are two API functions related to middleware - <a href="WebFrameworkShim.html#recordMiddleware"><code>WebFrameworkShim#recordMiddleware</code></a> and <code>WebFrameworkShim#wrapMiddlewareMounter</code>. Based on our web app code, we would expect to record a middleware metric for the authentication middleware, and also for the endpoint middleware that responds to a specific request. Here is what the instrumenation would look like:</p><pre class="prettyprint source lang-js"><code>let Server = myWebFramework.Server

shim.wrapMiddlewareMounter(Server.prototype, ['all', 'get'], {
  route: shim.FIRST,
  wrapper: function wrapMiddleware(shim, fn, name, route) {
    return shim.recordMiddleware(fn, new shim.specs.MiddlewareSpec({
      route: route,
      type: shim.MIDDLEWARE,
      req: shim.FIRST,
      res: shim.SECOND,
      next: shim.THIRD
    }))
  }
})

</code></pre><p>In order to record the correct middleware metrics, middleware functions should be wrapped using the <a href="WebFrameworkShim.html#recordMiddleware"><code>WebFrameworkShim#recordMiddleware</code></a> API method.</p><p>Note that middleware functions may not be exposed directly on the framework. So in order to get access to the middleware function so you can call <code>recordMiddleware</code>, you may need to wrap the framework method that is used to register the middleware.</p><p>A common pattern is a function that takes a path and one or more middleware functions. For example, Express has routing methods such as <code>get</code>, <code>post</code>, <code>put</code>, and <code>use</code>. The Restify framework has a similar pattern. In our example framework, we use the <code>get</code> and <code>all</code> methods the same way.</p><p>Since this is a common pattern, our API provides method <code>WebFrameworkShim#wrapMiddlewareMounter</code> to make it easier to wrap middlewares in this particular case. In cases where the framework has a different mechanism for registering middlewares, the instrumentation would need to fallback to basic wrapping (<a href="Shim.html#wrap"><code>Shim#wrap</code></a>) in order to get to the place where middleware functions can be intercepted. For an example of instrumentation that does not use <code>WebFrameworkShim#wrapMiddlewareMounter</code>, see our built-in Hapi instrumentation.</p><p>Going back to our instrumentation example... We will use the <code>WebFrameworkShim#wrapMiddlewareMounter</code> method to wrap <code>all</code> and <code>get</code>. The third argument in that call is the spec where we tell the instrumentation which argument is the route path, and what to do with all other arguments that represent the middleware functions. The instrumentation will call the <code>wrapper</code> function for each middleware function, and here we need to wrap the original function and return the wrapped version of it.</p><p>This is where <a href="WebFrameworkShim.html#recordMiddleware"><code>WebFrameworkShim#recordMiddleware</code></a> comes in. It takes the original middleware function as the first argument, and a spec describing the middleware function signature. The <code>req</code>, <code>res</code>, and <code>next</code> parameters tell the instrumentation which arguments are which. The <code>route</code> and <code>type</code> arguments are used for correctly naming the middleware metrics.</p><p>The following types are allowed:</p><p>| type | description | generated metric | trace segment | | --- | --- | --- | | MIDDLEWARE | Represents a generic middleware function. This could be a function that is executed for all types of requests (e.g. authentication), or a responder function associated (mounted) with a specific URL path. | <code>Nodejs/Middleware/&lt;framework&gt;/&lt;function name&gt;/&lt;mounted path&gt;</code> | <code>Middleware: &lt;function name&gt; &lt;mounted path&gt;</code><br><br>Note: If the middleware is nested under a ROUTE middleware, the path is omitted (since it's displayed in the ROUTE segment name). | | ERRORWARE | Used for recording middlewares that are used for handling errors. | <code>Nodejs/Middleware/&lt;framework&gt;/&lt;function name&gt;/&lt;mounted path&gt;</code><br><br>Note: The mounted path will reflect the path that was current when the error occurred. If the error handler itself is not mounted on a path, its path is appended to the originating path. | <code>Middleware: &lt;function name&gt; &lt;mounted path&gt;</code> | | PARAMWARE | This is a special type of middleware used for extracting parameters from URLs. | <code>Nodejs/Middleware/&lt;framework&gt;/&lt;function name&gt;//[param handler :&lt;param name&gt;]</code> | <code>Middleware: &lt;function name&gt; /[param handler :&lt;param name&gt;]</code> | | ROUTE | Used for grouping multiple middleware functions under a single route path. | no metric | <code>Route Path: &lt;mounted path&gt;</code> | | ROUTER | Used to create a trace segment for a router object that is mounted on a path. | no metric | <code>Router: &lt;mounted path&gt;</code> | | APPLICATION | Used for application object that is mounted as a router. This is a concept in Express, and typically will not be used in other framework instrumenations. | no metric | <code>Mounted App: &lt;mounted path&gt;</code> |</p><h3 id="views">Views</h3><p>Web frameworks will often provide mechanisms for rendering views from templates. Rendering views can be time consuming, and therefore New Relic can collect and display a specific metric (<code>View/&lt;view name&gt;/Rendering</code>) related to this. In order to capture these metrics, use the <a href="WebFrameworkShim.html#recordRender"><code>WebFrameworkShim#recordRender</code></a> API method.</p><p>Let's assume that the Server object in our custom web framework has a <code>render</code> function that takes the name of the view and a callback. The callback returns the generated content. In order to record this work as the View metric, we will do the following in our instrumentation:</p><pre class="prettyprint source lang-js"><code>let Server = myWebFramework.Server

shim.recordRender(Server.prototype, 'render', new shim.specs.RenderSpec({
  view: shim.FIRST,
  callback: shim.LAST
}))
</code></pre><p>[<img src="./trace-summary-view.png" alt="view segment" style="text-align:center;width:100%">]</p><p>Note that in some cases (e.g. in Express) the <code>render</code> function may be directly on the <code>req</code> object and may be invoked without accepting a callback. In this case calling the <code>render</code> function could be ending the HTTP response itself. In such a case, in order to capture correct timing for the render function, additional instrumentation would be needed based on how the web framework is implemented.</p><h3 id="errors">Errors</h3><p>Web frameworks will typically capture errors generated from middlewares (either uncaught or provided by the user, e.g. by calling <code>next(error)</code> in Express) and respond with a HTTP 500 error. If these errors are not handled by the user (e.g. using an errorware function), then it is more useful to report the original errors instead of a generic HTTP 500). The API provides the <a href="WebFrameworkShim.html#noticeError"><code>WebFrameworkShim#noticeError</code></a> method for reporting errors to New Relic.</p><p>Let's assume that our web framework emits an event everytime an error occurs. We can listen on this event, and call <a href="WebFrameworkShim.html#noticeError"><code>WebFrameworkShim#noticeError</code></a>.</p><pre class="prettyprint source lang-js"><code>server.on('error', function(req, error) {
  shim.noticeError(req, error)
})
</code></pre><p>Now let's assume that at a later point, the web framework calls a middleware where the user handles the error themselves. In this case, the error should no longer be reported. We can use the <a href="WebFrameworkShim.html#errorHandled"><code>WebFrameworkShim#errorHandled</code></a> function to remove the error:</p><pre class="prettyprint source lang-js"><code>shim.errorHandled(req, error)
</code></pre><h3 id="questions%3F">Questions?</h3><p>We have an extensive <a href="https://support.newrelic.com/">help site</a> as well as <a href="https://docs.newrelic.com/">documentation</a>. If you can't find your answers there, please drop us a line on the <a href="https://discuss.newrelic.com/">community forum</a>.</p></article></section></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="API.html">API</a></div><div class="sidebar-section-children"><a href="ClassWrapSpec.html">ClassWrapSpec</a></div><div class="sidebar-section-children"><a href="DatastoreParameters.html">DatastoreParameters</a></div><div class="sidebar-section-children"><a href="DatastoreShim.html">DatastoreShim</a></div><div class="sidebar-section-children"><a href="InstrumentationDescriptor.html">InstrumentationDescriptor</a></div><div class="sidebar-section-children"><a href="MessageShim.html">MessageShim</a></div><div class="sidebar-section-children"><a href="MessageSpec.html">MessageSpec</a></div><div class="sidebar-section-children"><a href="MessageSubscribeSpec.html">MessageSubscribeSpec</a></div><div class="sidebar-section-children"><a href="MiddlewareMounterSpec.html">MiddlewareMounterSpec</a></div><div class="sidebar-section-children"><a href="MiddlewareSpec.html">MiddlewareSpec</a></div><div class="sidebar-section-children"><a href="OperationSpec.html">OperationSpec</a></div><div class="sidebar-section-children"><a href="PromiseShim.html">PromiseShim</a></div><div class="sidebar-section-children"><a href="QuerySpec.html">QuerySpec</a></div><div class="sidebar-section-children"><a href="QueueMessageParameters.html">QueueMessageParameters</a></div><div class="sidebar-section-children"><a href="RecorderSpec.html">RecorderSpec</a></div><div class="sidebar-section-children"><a href="RenderSpec.html">RenderSpec</a></div><div class="sidebar-section-children"><a href="SegmentSpec.html">SegmentSpec</a></div><div class="sidebar-section-children"><a href="Shim.html">Shim</a></div><div class="sidebar-section-children"><a href="TransactionHandle.html">TransactionHandle</a></div><div class="sidebar-section-children"><a href="TransactionShim.html">TransactionShim</a></div><div class="sidebar-section-children"><a href="TransactionSpec.html">TransactionSpec</a></div><div class="sidebar-section-children"><a href="WebFrameworkShim.html">WebFrameworkShim</a></div><div class="sidebar-section-children"><a href="WrapSpec.html">WrapSpec</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Context-Preservation.html">Transaction State Preservation</a></div><div class="sidebar-section-children"><a href="tutorial-Datastore-Simple.html">Intro to Datastore Instrumentation</a></div><div class="sidebar-section-children"><a href="tutorial-Instrumentation-Basics.html">Instrumentation Basics</a></div><div class="sidebar-section-children"><a href="tutorial-Messaging-Simple.html">Intro to Message Broker Instrumentation</a></div><div class="sidebar-section-children"><a href="tutorial-Webframework-Simple.html">Intro to Web Framework Instrumentation</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-interfaces"><div>Interfaces</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="ParsedQueryData.html">ParsedQueryData</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#CallbackBindFunction">CallbackBindFunction</a></div><div class="sidebar-section-children"><a href="global.html#ClassWrapSpecParams">ClassWrapSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#ConstructorHookFunction">ConstructorHookFunction</a></div><div class="sidebar-section-children"><a href="global.html#DatastoreParametersParams">DatastoreParametersParams</a></div><div class="sidebar-section-children"><a href="global.html#InContextCallback">InContextCallback</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationDescriptorParams">InstrumentationDescriptorParams</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationOnError">InstrumentationOnError</a></div><div class="sidebar-section-children"><a href="global.html#InstrumentationOnRequire">InstrumentationOnRequire</a></div><div class="sidebar-section-children"><a href="global.html#MessageBrokerHeadersFn">MessageBrokerHeadersFn</a></div><div class="sidebar-section-children"><a href="global.html#MessageConsumerWrapperFunction">MessageConsumerWrapperFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageFunction">MessageFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageHandlerFunction">MessageHandlerFunction</a></div><div class="sidebar-section-children"><a href="global.html#MessageSpecParams">MessageSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MessageSubscribeSpecParams">MessageSubscribeSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareMounterSpecParams">MiddlewareMounterSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareSpecParams">MiddlewareSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareTypeNames">MiddlewareTypeNames</a></div><div class="sidebar-section-children"><a href="global.html#MiddlewareWrapperFunction">MiddlewareWrapperFunction</a></div><div class="sidebar-section-children"><a href="global.html#OperationSpecParams">OperationSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#QueryFunction">QueryFunction</a></div><div class="sidebar-section-children"><a href="global.html#QueryParserFunction">QueryParserFunction</a></div><div class="sidebar-section-children"><a href="global.html#QuerySpecFunction">QuerySpecFunction</a></div><div class="sidebar-section-children"><a href="global.html#QuerySpecParams">QuerySpecParams</a></div><div class="sidebar-section-children"><a href="global.html#QueueMessageParametersParams">QueueMessageParametersParams</a></div><div class="sidebar-section-children"><a href="global.html#RecorderFunction">RecorderFunction</a></div><div class="sidebar-section-children"><a href="global.html#RecorderSpecParams">RecorderSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#RenderSpecParams">RenderSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#RouteNextFunction">RouteNextFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteParameterFunction">RouteParameterFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteParserFunction">RouteParserFunction</a></div><div class="sidebar-section-children"><a href="global.html#RouteRequestFunction">RouteRequestFunction</a></div><div class="sidebar-section-children"><a href="global.html#SegmentFunction">SegmentFunction</a></div><div class="sidebar-section-children"><a href="global.html#SegmentSpecParams">SegmentSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#SpecAfterFunction">SpecAfterFunction</a></div><div class="sidebar-section-children"><a href="global.html#TransactionSpecParams">TransactionSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#WrapFunction">WrapFunction</a></div><div class="sidebar-section-children"><a href="global.html#WrapSpecParams">WrapSpecParams</a></div><div class="sidebar-section-children"><a href="global.html#createShimFromType">createShimFromType</a></div><div class="sidebar-section-children"><a href="global.html#startSegmentCallback">startSegmentCallback</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>